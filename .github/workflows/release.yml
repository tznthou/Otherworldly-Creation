name: ğŸš€ Release

on:
  push:
    tags: ['v*']

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: ğŸ‰ Create Release
        id: create_release
        run: |
          RELEASE_BODY="ğŸ® **å‰µä¸–ç´€å…ƒ - ç•°ä¸–ç•Œå‰µä½œç¥å™¨ v${{ steps.get_version.outputs.VERSION }}**

          ## ğŸ“¦ å®‰è£åŒ…ä¸‹è¼‰

          ### ğŸ macOS ç‰ˆæœ¬ (æ”¯æ´ Intel + Apple Silicon)
          
          #### ğŸ¥‡ **æ¨è–¦ï¼šDMG æ ¼å¼** (æ–°å¢ï¼)
          - **genesis-chronicle_v${{ steps.get_version.outputs.VERSION }}_universal.dmg**
          - âœ… **ç°¡å–®æ‹–æ”¾å®‰è£** - ç„¡éœ€ç®¡ç†å“¡æ¬Šé™
          - âœ… **å³é–‹å³ç”¨** - è‡ªå‹•è™•ç†æ‰€æœ‰æ¬Šé™å•é¡Œ
          - âœ… **ç†Ÿæ‚‰é«”é©—** - macOS æ¨™æº–å®‰è£æ–¹å¼
          
          #### ğŸ¢ **ä¼æ¥­é¸æ“‡ï¼šPKG æ ¼å¼** (å·²ä¿®å¾©ï¼)
          - **genesis-chronicle_v${{ steps.get_version.outputs.VERSION }}_universal.pkg**
          - âœ… **ä¸€éµå®‰è£** - ä¿®å¾©äº†å®‰è£è·¯å¾‘å•é¡Œ
          - âœ… **ä¼æ¥­å‹å¥½** - æ”¯æ´æ‰¹æ¬¡éƒ¨ç½²
          - âœ… **è‡ªå‹•æ¬Šé™** - ç„¡éœ€æ‰‹å‹•åŸ·è¡Œ xattr æŒ‡ä»¤

          **ç³»çµ±éœ€æ±‚**ï¼šmacOS 10.12+

          ### ğŸªŸ Windows ç‰ˆæœ¬  
          - **genesis-chronicle_v${{ steps.get_version.outputs.VERSION }}_x64.msi**
          - 64ä½å…ƒ Windows å®‰è£ç¨‹å¼
          - ç³»çµ±éœ€æ±‚ï¼šWindows 10+

          ## ğŸ†• æœ¬ç‰ˆæœ¬æ”¹é€²

          ### ğŸ”§ å®‰è£ç³»çµ±å…¨é¢å‡ç´š
          - âœ… **æ–°å¢ DMG æ ¼å¼**ï¼šæä¾› macOS ç”¨æˆ¶æœ€ç†Ÿæ‚‰çš„å®‰è£é«”é©—
          - âœ… **ä¿®å¾© PKG å•é¡Œ**ï¼šè§£æ±ºå®‰è£è·¯å¾‘éŒ¯èª¤ï¼Œç¢ºä¿æ­£ç¢ºå®‰è£åˆ° /Applications/
          - âœ… **ç‰ˆæœ¬çµ±ä¸€ç®¡ç†**ï¼šæ‰€æœ‰å¹³å°ç‰ˆæœ¬è™Ÿå®Œå…¨ä¸€è‡´
          - âœ… **è‡ªå‹•åŒ–æµç¨‹**ï¼šGitHub Actions å…¨è‡ªå‹•å»ºç½®å’Œç™¼å¸ƒ

          ### ğŸ’¡ å®‰è£å»ºè­°
          - **ä¸€èˆ¬ç”¨æˆ¶**ï¼šæ¨è–¦ä½¿ç”¨ DMG æ ¼å¼ï¼Œæ‹–æ”¾åˆ° Applications å³å¯
          - **ä¼æ¥­ç”¨æˆ¶**ï¼šå¯é¸æ“‡ PKG æ ¼å¼é€²è¡Œæ‰¹æ¬¡å®‰è£
          - **æ‰€æœ‰æ ¼å¼éƒ½å·²å®Œå…¨æ¸¬è©¦**ï¼Œé¸æ“‡ä½ åå¥½çš„æ–¹å¼å³å¯ï¼

          ## âœ¨ ä¸»è¦åŠŸèƒ½
          - ğŸ¤– **5å¤§AIä¾›æ‡‰å•†æ•´åˆ** (Ollama, OpenAI, Gemini, Claude, OpenRouter)
          - ğŸ“š **æ™ºèƒ½å°èªªå‰µä½œè¼”åŠ©** - AIé©…å‹•çš„å‰µä½œéˆæ„Ÿ
          - ğŸ“„ **EPUB/PDF é›™æ ¼å¼åŒ¯å‡º** - å°ˆæ¥­æ’ç‰ˆè¼¸å‡º
          - ğŸ­ **è§’è‰²åˆ†æèˆ‡åŠ‡æƒ…è¿½è¹¤** - æ·±åº¦è§’è‰²ä¸€è‡´æ€§åˆ†æ
          - ğŸ¨ **AI æ’ç•«ç”Ÿæˆ** - è¦–è¦ºåŒ–ä½ çš„æ•…äº‹ä¸–ç•Œ
          - ğŸ’¾ **è‡ªå‹•å„²å­˜èˆ‡å‚™ä»½** - æ°¸ä¸éºå¤±å‰µä½œæˆæœ

          ---

          ğŸ”¥ **è®“AIæˆç‚ºä½ çš„å‰µä½œå¤¥ä¼´ï¼Œé–‹å•Ÿç•°ä¸–ç•Œå†’éšªï¼**
          
          ğŸ“ **ç‰ˆæœ¬çµ±ä¸€ä¿è­‰**ï¼šæœ¬æ¬¡ç™¼å¸ƒæ‰€æœ‰å¹³å°ç‰ˆæœ¬è™Ÿå‡ç‚º v${{ steps.get_version.outputs.VERSION }}ï¼Œå¾¹åº•è§£æ±ºç‰ˆæœ¬ä¸ä¸€è‡´å•é¡Œï¼"
          
          # ä½¿ç”¨ gh CLI å‰µå»º release
          RELEASE_OUTPUT=$(gh release create ${{ steps.get_version.outputs.VERSION }} \
            --title "Genesis Chronicle ${{ steps.get_version.outputs.VERSION }}" \
            --notes "$RELEASE_BODY" \
            --draft=false \
            --prerelease=false)
          
          # å–å¾— upload URL (é›–ç„¶ gh CLI ä¸éœ€è¦ï¼Œä½†ä¿æŒç›¸å®¹æ€§)
          UPLOAD_URL=$(gh api repos/${{ github.repository }}/releases/tags/${{ steps.get_version.outputs.VERSION }} --jq .upload_url)
          echo "upload_url=$UPLOAD_URL" >> $GITHUB_OUTPUT
          echo "id=$(gh api repos/${{ github.repository }}/releases/tags/${{ steps.get_version.outputs.VERSION }} --jq .id)" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    needs: create-release
    runs-on: macos-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Setup version environment
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "PKG_VERSION=$VERSION" >> $GITHUB_ENV
          echo "ğŸ“¦ Release version: $VERSION"

      - name: ğŸ”„ Sync versions across all configs
        run: node scripts/sync-version.js

      - name: ğŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: ğŸ“¦ Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: ğŸ”§ Install Tauri CLI
        run: |
          if ! command -v cargo-tauri &> /dev/null; then
            echo "Installing Tauri CLI..."
            cargo install tauri-cli --version "^2.0"
          else
            echo "Tauri CLI already installed: $(cargo tauri --version)"
          fi

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build frontend
        run: npm run build:renderer

      - name: ğŸ”¨ Build Tauri app (DMG + App)
        run: |
          echo "ğŸš€ Building Tauri app with DMG support..."
          cd src-tauri
          cargo tauri build --target universal-apple-darwin
          echo "âœ… Tauri build completed"

      - name: ğŸ“¦ Create PKG installer
        run: |
          echo "ğŸ” Looking for generated .app file..."
          APP_PATH=$(find src-tauri/target -name "genesis-chronicle.app" -type d | head -1)
          
          if [ -z "$APP_PATH" ]; then
            echo "âŒ Error: genesis-chronicle.app not found"
            echo "ğŸ” Debug: Searching for any genesis-chronicle files:"
            find src-tauri/target -name "*genesis-chronicle*" -type f | head -10
            exit 1
          fi
          
          echo "âœ… Found app at: $APP_PATH"
          
          # å‰µå»º PKG è¼¸å‡ºç›®éŒ„
          mkdir -p dist
          
          # å‰µå»º PKG
          chmod +x ./scripts/create-pkg.sh
          PKG_NAME="genesis-chronicle_v${RELEASE_VERSION}_universal.pkg"
          echo "ğŸ“¦ Creating PKG: $PKG_NAME"
          ./scripts/create-pkg.sh "$APP_PATH" "dist/$PKG_NAME"

      - name: ğŸ” Verify build artifacts
        run: |
          echo "ğŸ” Checking build artifacts:"
          echo ""
          echo "ğŸ“ DMG files:"
          find src-tauri/target -name "*.dmg" -type f | while read -r dmg; do
            echo "   âœ… $(basename "$dmg") ($(du -h "$dmg" | cut -f1))"
          done
          echo ""
          echo "ğŸ“ PKG files:"
          find dist -name "*.pkg" -type f | while read -r pkg; do
            echo "   âœ… $(basename "$pkg") ($(du -h "$pkg" | cut -f1))"
          done
          echo ""
          
          # æª¢æŸ¥æ˜¯å¦è‡³å°‘æœ‰ä¸€å€‹ DMG å’Œä¸€å€‹ PKG
          DMG_COUNT=$(find src-tauri/target -name "*.dmg" -type f | wc -l)
          PKG_COUNT=$(find dist -name "*.pkg" -type f | wc -l)
          
          if [ "$DMG_COUNT" -eq 0 ]; then
            echo "âŒ Error: No DMG files found"
            exit 1
          fi
          
          if [ "$PKG_COUNT" -eq 0 ]; then
            echo "âŒ Error: No PKG files found"
            exit 1
          fi
          
          echo "âœ… Build verification passed: $DMG_COUNT DMG(s) + $PKG_COUNT PKG(s)"

      - name: ğŸ“¤ Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.RELEASE_VERSION }}
          files: |
            src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg
            dist/*.pkg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    needs: create-release
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Setup version environment
        run: |
          $VERSION = "${{ github.ref }}".Replace("refs/tags/v", "")
          echo "RELEASE_VERSION=$VERSION" >> $env:GITHUB_ENV
          echo "ğŸ“¦ Release version: $VERSION"

      - name: ğŸ”„ Sync versions across all configs
        run: node scripts/sync-version.js

      - name: ğŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: ğŸ“¦ Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: ğŸ”§ Install Tauri CLI
        run: |
          if (!(Get-Command "cargo-tauri" -ErrorAction SilentlyContinue)) {
            echo "Installing Tauri CLI..."
            cargo install tauri-cli --version "^2.0"
          } else {
            echo "Tauri CLI already installed: $(cargo tauri --version)"
          }

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build frontend
        run: npm run build:renderer

      - name: ğŸ”¨ Build Tauri app (MSI)
        run: |
          echo "ğŸš€ Building Tauri app for Windows..."
          cd src-tauri
          cargo tauri build --target x86_64-pc-windows-msvc
          echo "âœ… Tauri Windows build completed"

      - name: ğŸ” Verify Windows build artifacts
        run: |
          echo "ğŸ” Checking Windows build artifacts:"
          Get-ChildItem -Path "src-tauri/target" -Recurse -Include "*.msi" | ForEach-Object {
            $size = [math]::Round($_.Length / 1MB, 2)
            echo "   âœ… $($_.Name) ($size MB)"
          }

      - name: ğŸ“¤ Upload Windows Release Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.RELEASE_VERSION }}
          files: src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}