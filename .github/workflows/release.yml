name: ğŸš€ Release

on:
  push:
    tags: ['v*']

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: ğŸ‰ Create Release
        id: create_release
        run: |
          RELEASE_BODY="ğŸ® **å‰µä¸–ç´€å…ƒ - ç•°ä¸–ç•Œå‰µä½œç¥å™¨**

          ## ğŸ“¦ å®‰è£åŒ…ä¸‹è¼‰

          ### ğŸ macOS ç‰ˆæœ¬
          - **genesis-chronicle-${{ steps.get_version.outputs.VERSION }}-universal.dmg** (æ‹–æ”¾å®‰è£)
          - **genesis-chronicle-${{ steps.get_version.outputs.VERSION }}-universal.pkg** (ä¸€éµå®‰è£ï¼Œç„¡éœ€æ‰‹å‹•ç§»é™¤éš”é›¢)
          - æ”¯æ´ Intel + Apple Silicon Mac
          - ç³»çµ±éœ€æ±‚ï¼šmacOS 10.11+

          #### ğŸ“‹ macOS å®‰è£èªªæ˜
          - **æ¨è–¦ä½¿ç”¨ .pkg å®‰è£ç¨‹å¼**ï¼šè‡ªå‹•è™•ç†ç³»çµ±æ¬Šé™ï¼Œç„¡éœ€æ‰‹å‹•åŸ·è¡Œ \`xattr\` æŒ‡ä»¤
          - å¦‚ä½¿ç”¨ .dmgï¼šä¸‹è¼‰å¾Œéœ€åŸ·è¡Œ \`sudo xattr -rd com.apple.quarantine /Applications/genesis-chronicle.app\`

          ### ğŸªŸ Windows ç‰ˆæœ¬  
          - **genesis-chronicle-${{ steps.get_version.outputs.VERSION }}-x64.msi**
          - 64ä½å…ƒ Windows å®‰è£ç¨‹å¼
          - ç³»çµ±éœ€æ±‚ï¼šWindows 10+

          ## âœ¨ ä¸»è¦åŠŸèƒ½
          - ğŸ¤– 5å¤§AIä¾›æ‡‰å•†æ•´åˆ (Ollama, OpenAI, Gemini, Claude, OpenRouter)
          - ğŸ“š æ™ºèƒ½å°èªªå‰µä½œè¼”åŠ©
          - ğŸ“„ EPUB/PDF é›™æ ¼å¼åŒ¯å‡º
          - ğŸ­ è§’è‰²åˆ†æèˆ‡åŠ‡æƒ…è¿½è¹¤
          - ğŸ’¾ è‡ªå‹•å„²å­˜èˆ‡å‚™ä»½

          ---

          ğŸ”¥ **è®“AIæˆç‚ºä½ çš„å‰µä½œå¤¥ä¼´ï¼Œé–‹å•Ÿç•°ä¸–ç•Œå†’éšªï¼**"
          
          # ä½¿ç”¨ gh CLI å‰µå»º release
          RELEASE_OUTPUT=$(gh release create ${{ steps.get_version.outputs.VERSION }} \
            --title "Genesis Chronicle ${{ steps.get_version.outputs.VERSION }}" \
            --notes "$RELEASE_BODY" \
            --draft=false \
            --prerelease=false)
          
          # å–å¾— upload URL (é›–ç„¶ gh CLI ä¸éœ€è¦ï¼Œä½†ä¿æŒç›¸å®¹æ€§)
          UPLOAD_URL=$(gh api repos/${{ github.repository }}/releases/tags/${{ steps.get_version.outputs.VERSION }} --jq .upload_url)
          echo "upload_url=$UPLOAD_URL" >> $GITHUB_OUTPUT
          echo "id=$(gh api repos/${{ github.repository }}/releases/tags/${{ steps.get_version.outputs.VERSION }} --jq .id)" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    needs: create-release
    runs-on: macos-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: ğŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: ğŸ“¦ Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build frontend
        run: npm run build:renderer

      - name: ğŸ”¨ Build Tauri app  
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: '--target universal-apple-darwin'
        continue-on-error: true
          
      - name: ğŸ”„ Fallback: Try alternative build
        if: failure()
        run: |
          echo "ğŸ”„ Primary build failed, trying alternative..."
          # å˜—è©¦ä¸åŒçš„æ§‹å»ºæ–¹å¼
          cargo tauri build --target aarch64-apple-darwin || cargo tauri build --target x86_64-apple-darwin
          
      - name: ğŸ“¦ Create PKG installer
        if: always()
        run: |
          # æ‰¾åˆ°ç”Ÿæˆçš„ .app æ–‡ä»¶ï¼ˆæ”¯æ´å¤šç¨®æ¶æ§‹ï¼‰
          APP_PATH=$(find src-tauri/target -name "genesis-chronicle.app" -type d | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "âŒ Error: genesis-chronicle.app not found"
            echo "ğŸ” Target directory structure:"
            find src-tauri/target -type f -name "*genesis-chronicle*" | head -10
            echo "ğŸ” Looking for any .app files:"
            find src-tauri/target -name "*.app" -type d | head -5
            exit 1
          fi
          
          echo "âœ… Found app at: $APP_PATH"
          
          # æª¢æ¸¬æ¶æ§‹é¡å‹
          ARCH_TYPE="universal"
          if [[ "$APP_PATH" == *"aarch64"* ]]; then
            ARCH_TYPE="aarch64"
          elif [[ "$APP_PATH" == *"x86_64"* ]]; then
            ARCH_TYPE="x86_64"
          fi
          
          echo "ğŸ—ï¸ Architecture: $ARCH_TYPE"
          
          # å‰µå»ºPKGç›®éŒ„
          PKG_DIR="$(dirname "$APP_PATH")/pkg"
          mkdir -p "$PKG_DIR"
          
          # ç”ŸæˆPKG
          chmod +x ./scripts/create-pkg.sh
          PKG_NAME="genesis-chronicle_${{ steps.get_version.outputs.VERSION }}_${ARCH_TYPE}.pkg"
          ./scripts/create-pkg.sh "$APP_PATH" "$PKG_DIR/$PKG_NAME"
        
      - name: ğŸ“¤ Upload PKG to Release
        if: always()
        run: |
          # æ‰¾åˆ°ç”Ÿæˆçš„ PKG æ–‡ä»¶ï¼ˆæ”¯æ´å¤šç¨®å‘½åï¼‰
          PKG_PATH=$(find src-tauri/target -name "genesis-chronicle_${{ steps.get_version.outputs.VERSION }}_*.pkg" -type f | head -1)
          if [ -z "$PKG_PATH" ]; then
            echo "âŒ Error: PKG file not found"
            echo "ğŸ” Searching for any PKG files:"
            find src-tauri/target -name "*.pkg" -type f | head -5
            echo "ğŸ” Target directory contents:"
            find src-tauri/target -type f | grep -E "\.(pkg|dmg|app)$" | head -10
          else
            echo "âœ… Found PKG at: $PKG_PATH"
            # ä¸Šå‚³åˆ° Release
            gh release upload ${{ steps.get_version.outputs.VERSION }} "$PKG_PATH" --clobber || echo "âš ï¸ Failed to upload PKG"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    needs: create-release
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: ğŸ“¦ Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build frontend
        run: npm run build:renderer

      - name: ğŸ”¨ Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: '--target x86_64-pc-windows-msvc'
          releaseId: ${{ needs.create-release.outputs.release_id }}