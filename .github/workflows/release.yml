name: ğŸš€ Release

on:
  push:
    tags: ['v*']

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: ğŸ‰ Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          release_name: Genesis Chronicle ${{ steps.get_version.outputs.VERSION }}
          body: |
            ğŸ® **å‰µä¸–ç´€å…ƒ - ç•°ä¸–ç•Œå‰µä½œç¥å™¨**
            
            ## ğŸ“¦ å®‰è£åŒ…ä¸‹è¼‰
            
            ### ğŸ macOS ç‰ˆæœ¬
            - **genesis-chronicle-${{ steps.get_version.outputs.VERSION }}-universal.dmg**
            - æ”¯æ´ Intel + Apple Silicon Mac
            - ç³»çµ±éœ€æ±‚ï¼šmacOS 10.11+
            
            ### ğŸªŸ Windows ç‰ˆæœ¬  
            - **genesis-chronicle-${{ steps.get_version.outputs.VERSION }}-x64.msi**
            - 64ä½å…ƒ Windows å®‰è£ç¨‹å¼
            - ç³»çµ±éœ€æ±‚ï¼šWindows 10+
            
            ## âœ¨ ä¸»è¦åŠŸèƒ½
            - ğŸ¤– 5å¤§AIä¾›æ‡‰å•†æ•´åˆ (Ollama, OpenAI, Gemini, Claude, OpenRouter)
            - ğŸ“š æ™ºèƒ½å°èªªå‰µä½œè¼”åŠ©
            - ğŸ“„ EPUB/PDF é›™æ ¼å¼åŒ¯å‡º
            - ğŸ­ è§’è‰²åˆ†æèˆ‡åŠ‡æƒ…è¿½è¹¤
            - ğŸ’¾ è‡ªå‹•å„²å­˜èˆ‡å‚™ä»½
            
            ---
            
            ğŸ”¥ **è®“AIæˆç‚ºä½ çš„å‰µä½œå¤¥ä¼´ï¼Œé–‹å•Ÿç•°ä¸–ç•Œå†’éšªï¼**
          draft: false
          prerelease: false

  build-macos:
    needs: create-release
    runs-on: macos-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: ğŸ“¦ Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build frontend
        run: npm run build:renderer

      - name: ğŸ”¨ Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}

  build-windows:
    needs: create-release
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: ğŸ“¦ Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build frontend
        run: npm run build:renderer

      - name: ğŸ”¨ Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: '--target x86_64-pc-windows-msvc'
          releaseId: ${{ needs.create-release.outputs.release_id }}