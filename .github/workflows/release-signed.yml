name: ğŸš€ Signed Release

on:
  push:
    tags: ['v*-signed']

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: ğŸ‰ Create Signed Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          release_name: Genesis Chronicle ${{ steps.get_version.outputs.VERSION }} (Signed)
          body: |
            ğŸ® **å‰µä¸–ç´€å…ƒ - ç•°ä¸–ç•Œå‰µä½œç¥å™¨** (Apple å®˜æ–¹ç°½åç‰ˆ)
            
            ## ğŸ“¦ å®‰è£åŒ…ä¸‹è¼‰ - å®˜æ–¹ç°½åç‰ˆæœ¬
            
            ### ğŸ macOS ç‰ˆæœ¬ (å·²ç°½å)
            - **genesis-chronicle-${{ steps.get_version.outputs.VERSION }}-universal-signed.dmg**
            - âœ… Apple å®˜æ–¹ä»£ç¢¼ç°½å
            - âœ… å·²é€šéå…¬è­‰ (Notarized)
            - âœ… å¯ç›´æ¥å®‰è£ï¼Œç„¡å®‰å…¨è­¦å‘Š
            - æ”¯æ´ Intel + Apple Silicon Mac
            - ç³»çµ±éœ€æ±‚ï¼šmacOS 10.15+
            
            ### ğŸªŸ Windows ç‰ˆæœ¬  
            - **genesis-chronicle-${{ steps.get_version.outputs.VERSION }}-x64.msi**
            - 64ä½å…ƒ Windows å®‰è£ç¨‹å¼
            - ç³»çµ±éœ€æ±‚ï¼šWindows 10+
            
            ## âœ¨ ä¸»è¦åŠŸèƒ½
            - ğŸ¤– 5å¤§AIä¾›æ‡‰å•†æ•´åˆ (Ollama, OpenAI, Gemini, Claude, OpenRouter)
            - ğŸ“š æ™ºèƒ½å°èªªå‰µä½œè¼”åŠ©
            - ğŸ“„ EPUB/PDF é›™æ ¼å¼åŒ¯å‡º
            - ğŸ­ è§’è‰²åˆ†æèˆ‡åŠ‡æƒ…è¿½è¹¤
            - ğŸ’¾ è‡ªå‹•å„²å­˜èˆ‡å‚™ä»½
            
            ## ğŸ”’ å®‰å…¨æ€§
            - âœ… Apple é–‹ç™¼è€… ID ç°½å
            - âœ… é€šé Apple å…¬è­‰ç³»çµ±
            - âœ… ç„¡éœ€æ‰‹å‹•è§£é™¤å®‰å…¨é™åˆ¶
            
            ---
            
            ğŸ”¥ **å®˜æ–¹ç°½åç‰ˆæœ¬ - å®‰è£æ›´å®‰å…¨ï¼Œä½¿ç”¨æ›´æ”¾å¿ƒï¼**
          draft: false
          prerelease: false

  build-macos-signed:
    needs: create-release
    runs-on: macos-latest
    timeout-minutes: 45
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: ğŸ“¦ Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build frontend
        run: npm run build:renderer

      # ğŸ”‘ Apple ä»£ç¢¼ç°½åè¨­å®š
      - name: ğŸ Import Apple Developer Certificate
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # å‰µå»ºè‡¨æ™‚ keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # å°å…¥ Apple é–‹ç™¼è€…æ†‘è­‰
          echo $APPLE_CERTIFICATE | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          
          # åˆ—å‡ºå¯ç”¨çš„ç°½åèº«ä»½
          security find-identity -v

      - name: ğŸ”¨ Build and Sign Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          # Tauri æœƒè‡ªå‹•ä½¿ç”¨æ‰¾åˆ°çš„ç°½åèº«ä»½é€²è¡Œç°½åå’Œå…¬è­‰

      # ğŸ§¹ æ¸…ç†
      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          security delete-keychain build.keychain
          rm -f certificate.p12

  build-windows:
    needs: create-release
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: ğŸ“¦ Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build frontend
        run: npm run build:renderer

      - name: ğŸ”¨ Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: '--target x86_64-pc-windows-msvc'
          releaseId: ${{ needs.create-release.outputs.release_id }}